<!--
title: "Стандарт оформления кода на C"
date: 16-03-1029
-->

# Стандарт оформления кода на C

## Введения

Данный документ дает рекомендации по написанию и оформлению кода на языке C. Он вдохновлялся
[аналогичным](https://www.python.org/dev/peps/pep-0007/) стандартом для проекта CPython.

Соблюдение единого и чистого стиля кода позволяет тысячекратно повысить читаемость кода, скорость отладки и поиска
ошибок. Наш проект достаточно крупный и над ним работает достаточное количество человек, чтобы правильное оформление
кода стало особо важно в разработке.

Это руководство очень короткое и не охватывает все возможные, порой важные, детали. Потому настоятельно рекомендуется
ознакомится со статьями из раздела [См. также](#См.-также) (особенно под пунктами 1 и 3).

Приведенные правила могут быть нарушены, при наличии на то причины. Например:

1.  Применение совета может ухудшить читаемость кода в данном случае.

2.  Применения совета может привести к нарушению единообразия стиля в данном месте программы (то есть, если в этом месте
    уже применялись специфичные стили оформления).

3.  Есть персональные возражения по каким-то пунктам (пожалуйста, тогда сообщите об этом).

## Диалект языка C

*   1.1. Следует использовать стандарт ANSI C (C89). Допустимы также некоторые особенности стандарта C99:

    *   Однострочные комментарии в стиле C++ (начинающиеся с `//`).
  
*   1.2. Запрещается использование расширений компиляторов.

*   1.3. Каждая функция должна иметь полный прототип в соответствующем заголовочном файле.

*   1.4. Требуется добиваться отсутствия предупреждений компилятора при сборке.

## Структура кода

*   2.1. Использовать отступ в 4 пробела (табы запрещаются).

*   2.2. Строки должна быть не длиннее 79 символов.

*   2.3. Строки не должны заканчиваться пробелом.

*   2.4. Ставьте пустые строки между функциями, определениями структур и другими логическими блоками (в том числе в
    теле функции)

*   2.5. Стиль оформления определения функции:

    ```c
    int Vector_dot_product(Vector *v1, Vector *v2) {
        ...
    }
    ```

*   2.6. Локальные переменные объявляются в начале функции и отделяются от основного кода пустой строкой.

*   2.7. Перед открывающейся фигурной скобкой (`{`) следует ставить один пробел. Фигурные скобки требуется всегда
    ставить явно (даже, если они не требуются синтаксисом).

*   2.8. Условные оператор оформляется следующим образом (`else if` и/или `else` могут отсутствовать):

    ```c
    if (FAIL(err)) {
        // ...
    }
    else if (ar == NULL) {
        // ...
    }
    else {
        // ...
    }
    ```

*   2.9. При вызове функций и макросов пробелы перед круглыми скобками не ставятся

    ```c
    foo(a, b, c);
    ```

*   2.10. Всегда ставится пробел вокруг арифметических, побитовых и логических бинарных операторов (`+`, `-`, `*`, `/`,
    `&&`, `|`, `==`, `=` и т. д. ). Можно не ставить пробелы вокруг действий умножения и деления.

    ```c
    a = (5 * 3 - 1 ) << (1 | 0);
    b = !(++a);
    ```

*   2.11. Старайтесь разрывать длинные строки (в соответствии с 2.2) по запятой или оператору, оставляя их на предыдущей
    строке.

    ```c
        int BmpImageHeader_is_valid(BmpImageHeader *header, int file_size) {
            int is_valid;
            is_valid = !(header->bf_size != file_size ||
                         header->bf_reserved1 != 0 ||
                         header->bf_reserved2 != 0 ||
                         header->bi_planes != 1 ||
                         (header->bi_size != 40 && header->bi_size != 108 && header->bi_size != 124) ||
                         header->bf_offbits != header->bi_size+14 ||
                         header->bi_width < 1 || header->bi_width > 10000 ||
                         header->bi_height < 1 || header->bi_height > 10000 ||
                         header->bi_bit_count != 24 ||
                         header->bi_compression !=  0
                        );

            return is_valid;
    }
    ```

*   2.12. Комментарии должны идти непосредственно выше кода, который они поясняют. Текст в комментарии должен начинаться
    с большой буквы, заканчиваться точкой и быть отделенным от `//` пробелом.

    Используйте комментарии только если на то есть особая причина (код в большинстве случаев должен быть понятен и без них).

*   2.13. В случае, если во время выполнения функции может произойти ошибка, то функция должна возвращать эту ошибку (обычно
    тип `error_t`). Результат передается через указатель.

    ```c
    error_t parse_i(char *str, int *parsed_value) {
        // ...
    }
    ```

*   2.14 Разрешается использовать в функциях больше одного `return`, а так же ключевые слова `break` и `continue`. Но
    тогда следует внимательно следить за очищением ресурсов (например, очистка выделенной памяти).

*   2.15 Запрещается в конструкции (заголовке) цикла `for` использовать переменные, не относящиеся к циклу, например,
    флаги (заменяйте их на `continue` и `break`).

    ```c
    // НЕЛЬЗЯ:
    // for (i = 0, a = -3; i < 10 && !exit; i++) {
    //     // ...
    // }

    a = -3;
    for (i = 0; i < 10; i++) {
        if (err) {
            // ...
            break;
        }
        // ...
    }
    ```

## Основные соглашения об именовании

*   3.1. Именуйте функции и переменные с использованием snake_case (т. е. слова_разделяются_нижними_подчеркиваниями).

*   3.2. Если функция используется для работы с пользовательскими структурами (главный признак - ее основным, обычно
    первым, параметром является структура), то называйте ее по шаблону

    ```plaintext
    <тип> ИмяСтруктуры_имя_функции(<параметры>);
    ```

*   3.3 Все define'ы именуются ЗАГЛАВНЫМИ_БУКВАМИ_В_SNAKE_CASE.

*   3.4 Структуры именуются в CamelCase (между словами нет разделителя, каждое слово - с заглавной буквы).

    ```c
    typedef struct {
        Worker source;
        int is_successful;
        int index;
    } SuspendedWorker;
    ```

*   3.5 Старайтесь давать осмысленные имена на английском языке.

    Иногда допускается и даже рекомендуется сокращать имена, если выполняется одно из условий:

    *   Сокращение не повлияет на понимание кода, но сократит лишний объем кода
    *   Переменная практически не влияет на понимание кода.
    *   Объем кода, в котором используется эта переменная, мал.
    *   Это распространённое сокращение (счетчик в цикле - `i`, `j`, `k`; временная переменная - `t`; и т. д.).

## Принципы документирования

*   4.1 Каждый функция должна должна быть документирована с помощью системы документирования Doxygen.

    Замечание: [Doxygen](https://ru.wikipedia.org/wiki/Doxygen) - популярная система документирования, имеющая
    широкий функционал. Мы будем использовать только несколько его ключевых слов (ключей). Следующий пример демонстрирует
    синтаксис, который будем использовать:

    ```c
    /**
     * Создает новый экземпляр Complex с начальными значениями.
     *
     * @param complex Комплексное число.
     * @param float real Вещественная часть числа.
     * @param float imag Мнимая часть числа.
     * @return error_t Код ошибки (или 0, если ошибки не произошло).
     *
     * @author Степан Репин
     *
    */
    error_t Complex_new_with_init(Complex **complex, float real, float imag) {
        // ...
    }
    ```

    Обратите внимание на последовательность ключей, пустые строки и две звездочки в самом верху (`/**`) - они обязательны.

## См. также

1.  Что такое красивый код, и как его писать? - <https://habr.com/ru/post/266969/>
2.  PEP-7 - <https://www.python.org/dev/peps/pep-0007/>
3.  90 рекомендаций по стилю написания программ на C++ - <https://habr.com/ru/post/172091/>